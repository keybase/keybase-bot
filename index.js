!function(e,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var t=n();for(var s in t)("object"==typeof exports?exports:e)[s]=t[s]}}(global,function(){return function(e){var n={};function t(s){if(n[s])return n[s].exports;var a=n[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,t),a.l=!0,a.exports}return t.m=e,t.c=n,t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:s})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(t.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var a in e)t.d(s,a,function(n){return e[n]}.bind(null,a));return s},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=1)}([function(e,n){e.exports=require("child_process")},function(e,n,t){"use strict";t.r(n);var s=t(0);function a(e,n){var t=e.stdinBuffer,a=null,o=null,r=[],i=Object(s.spawn)(e.command,e.args||[]);t&&(i.stdin.write(t),i.stdin.end()),i.stdout.on("data",function(e){r.push(e)}),i.on("close",function(e){if(e)o=new Error("exited with code ".concat(e));else{var t=Buffer.concat(r).toString("utf8");try{a=JSON.parse(t)}catch(e){o=e}}n(o,a)})}function o(e){!function(e){a({command:"keybase",args:["status","-j"]},function(n,t){e(n,t)})}(function(n,t){return t&&t.Username&&t.Device&&t.Device.name?e(null,{username:t.Username,devicename:t.Device.name}):(n||(n=new Error("failed to get username + device name")),e(n,null))})}function r(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var i=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this._bot=n.bot,this._onMessages=n.onMessages,this._channel=n.channel,this._highestId=-1,this._loopCount=0,this._watchLoop()}return function(e,n,t){n&&r(e.prototype,n),t&&r(e,t)}(e,[{key:"_didISendMessage",value:function(e){var n=this._bot.myInfo();return!!n&&n.username===e.msg.sender.username}},{key:"_checkForNewMessages",value:function(e){var n=this,t=[];this._bot.chatRead({channel:this._channel,unreadOnly:!0},function(s,a){return s&&console.log(s),a&&a.ratelimits&&n._bot._gasPreserver.passGas(a.ratelimits),a&&a.messages&&(t=a.messages,n._highestId=a.messages.reduce(function(e,n){return Math.max(e,n.msg.id)},n._highestId)),console.log("loopCount: ".concat(n._loopCount," newMessages: ").concat(t.length)),t.length&&n._onMessages({messages:t,channel:n._channel}),e(s)})}},{key:"_watchLoop",value:function(){var e=this;console.log("".concat(this._loopCount," '").concat(this._channel.name," entering watchLoop")),this._checkForNewMessages(function(){var n=e._bot._gasPreserver.recommendedWait();console.log("".concat(e._loopCount," '").concat(e._channel.name," finishing watchLoop ").concat(n)),setTimeout(function(){e._loopCount++,e._watchLoop()},n)})}}]),e}();function c(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var l=function(){function e(n){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this._bot=n.bot,this._onMessages=n.onMessages,this._loopCount=0,this._watchLoop()}return function(e,n,t){n&&c(e.prototype,n),t&&c(e,t)}(e,[{key:"_checkForNewMessagesInOneConversation",value:function(e,n){var t=this;this._bot.chatRead({channel:e.channel,unreadOnly:!0},function(s,a){if(a&&a.ratelimits&&t._bot._gasPreserver.passGas(a.ratelimits),a&&a.messages){var o=a.messages;console.log("found: ".concat(o.length," newMessages: ").concat(e.channel)),a.messages.length&&t._onMessages({messages:o,channel:e.channel})}n(s)})}},{key:"_checkForNewMessagesInConversations",value:function(e,n){var t=this,s=e.conversations,a=e.index;if(a||(a=0),a===s.length)return n(null);console.log("CHECKING ".concat(a,", ").concat(s[a].channel," for new messages")),this._checkForNewMessagesInOneConversation(s[a],function(e,o){if(a+1===s.length)return n(e);t._checkForNewMessagesInConversations({conversations:s,index:a+1},n)})}},{key:"_checkForNewMessagesInAllConversations",value:function(e){var n=this;this._bot.chatList(null,function(t,s){if(t)return console.log("Got error getting chat list:",t),e(t);if(s&&s.ratelimits&&n._bot._gasPreserver.passGas(s.ratelimits),s&&s.conversations){var a=s.conversations.filter(function(e){return e.unread});console.log("Of ".concat(s.conversations.length," there are ").concat(a.length," that are unread.")),n._checkForNewMessagesInConversations({conversations:a},function(n){e(n)})}})}},{key:"_watchLoop",value:function(){var e=this;this._checkForNewMessagesInAllConversations(function(){var n=e._bot._gasPreserver.recommendedWait();setTimeout(function(){e._loopCount++,e._watchLoop()},n)})}}]),e}(),u={MIN_CHANNEL_WATCH_LOOP:1e3,MAX_CHANNEL_WATCH_LOOP:6e4,DEFAULT_GAS:500,DEFAULT_TIME_LEFT:1500,TARGET_GAS_REMAINING:100,SAFETY_BUFFER:1.5,GAS_MONITOR_WINDOW:1e4,GAS_ADJ_MULT:1.1};function h(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var f=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this._lastPassedGas=[],this._currentWait=u.MIN_CHANNEL_WATCH_LOOP}return function(e,n,t){n&&h(e.prototype,n),t&&h(e,t)}(e,[{key:"passGas",value:function(e){this._lastPassedGas.push(e[0]),this._filterOldGas()}},{key:"recommendedWait",value:function(){var e=this._getCurrentSpeed(),n=this._getRemainingGas(),t=Math.max(0,n-u.TARGET_GAS_REMAINING),s=this._getTimeTillReset();return e*s>t?this._currentWait*=u.GAS_ADJ_MULT:this._currentWait/=u.GAS_ADJ_MULT,this._currentWait=Math.max(u.MIN_CHANNEL_WATCH_LOOP,this._currentWait),this._currentWait=Math.min(u.MAX_CHANNEL_WATCH_LOOP,this._currentWait),console.log("...speed=".concat(e.toFixed(2),", gas=").concat(n,", timeLeft=").concat(s,", currentWait=").concat(this._currentWait,", history=").concat(this._lastPassedGas.length)),this._currentWait}},{key:"_filterOldGas",value:function(){var e=0;for(e=this._lastPassedGas.length-2;e>=0;e--){var n=this._lastPassedGas[this._lastPassedGas.length-1],t=this._lastPassedGas[e];if(t.gas<n.gas||t.reset<n.reset)break}if(e>=0&&(console.log("BEFORE GAS CLEANUP",this._lastPassedGas),this._lastPassedGas.splice(0,e+1),console.log("AFTER GAS CLEANUP",this._lastPassedGas)),this._lastPassedGas.length>2){var s=this._lastPassedGas.slice(-2),a=this._lastPassedGas.slice(0,-2);a=a.filter(function(e){return e.reset<s[1].reset+u.GAS_MONITOR_WINDOW/1e3}),this._lastPassedGas=a.concat(s)}}},{key:"_getCurrentSpeed",value:function(){if(this._lastPassedGas.length<2)return 1;var e=this._lastPassedGas,n=e[e.length-1];return(e[0].gas-n.gas)/(1+e[0].reset-n.reset)}},{key:"_getRemainingGas",value:function(){return this._lastPassedGas.length<1?u.DEFAULT_GAS:this._lastPassedGas[this._lastPassedGas.length-1].gas}},{key:"_getTimeTillReset",value:function(){return this._lastPassedGas.length<1?u.DEFAULT_TIME_LEFT:this._lastPassedGas[this._lastPassedGas.length-1].reset}}]),e}();function _(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}var d=function(){function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this._verbose=!1,this._dPair=null,this._initialized=!1,this._channelWatchers=new Map,this._fullWatcher=null,this._gasPreserver=new f}return function(e,n,t){n&&_(e.prototype,n),t&&_(e,t)}(e,[{key:"init",value:function(e,n){var t=this;this._verbose=e.verbose,function(e,n){var t=Object(s.spawn)("keybase",e.args),a=[],o=null,r=null;e.stdinBuffer&&(t.stdin.write(e.stdinBuffer),t.stdin.end()),t.stdout.on("data",function(e){a.push(e)}),t.on("close",function(e){if(e)r=new Error("exited with code ".concat(e));else{var n=Buffer.concat(a).toString("utf8");try{o=""===n?n:JSON.parse(n)}catch(e){r=e}}}),n&&n(r,o)}({args:["oneshot","--username",e.username,"--paperkey",e.paperkey]},function(){o(function(e,s){s&&(t._dPair=s,t._log("intialized ".concat(s.username," (device=").concat(s.devicename,")"))),t._initialized=!0,n(e)})})}},{key:"chatList",value:function(e,n){if(e)throw new Error("options (arg1) for chatList not yet supported. Please pass null.");this._safelyRunApiCommand({method:"list",options:{}},function(e,t){return n(e,t)})}},{key:"chatSend",value:function(e,n){var t=e.channel,s=e.message;this._safelyRunApiCommand({method:"send",options:{channel:t,message:s}},function(e,t){return n(e,t)})}},{key:"chatRead",value:function(e,n){var t=e.channel,s=!1,a=!1;void 0!==e.peek&&(s=e.peek),void 0!==e.unreadOnly&&(a=e.unreadOnly),this._safelyRunApiCommand({method:"read",options:{channel:t,peek:s,unreadOnly:a}},function(e,t){return n(e,t)})}},{key:"chatDelete",value:function(e,n){var t=e.channel,s=e.messageId;this._safelyRunApiCommand({method:"delete",options:{channel:t,messageId:s}},function(e,t){return n(e,t)})}},{key:"myInfo",value:function(){return this._dPair}},{key:"watchChannelForNewMessages",value:function(e){var n=e.channel,t=e.onMessages,s=function(e){return JSON.stringify([e.name,e.public,e.topic_type])}(n);if(this._channelWatchers.has(s))throw new Error("already watching the channel ".concat(JSON.stringify(n)));this._channelWatchers.set(s,new i({channel:n,onMessages:t,bot:this}))}},{key:"watchAllChannelsForNewMessages",value:function(e){var n=e.onMessages;if(this._fullWatcher)throw new Error("already watching watching; can't have 2 message watchers}");this._fullWatcher=new l({onMessages:n,bot:this})}},{key:"_log",value:function(e){this._verbose&&console.log(e)}},{key:"_checkUserAndInit",value:function(e){var n=this;o(function(t,s){return t||n._initialized&&s&&n._dPair&&s.username===n._dPair.username||(t=new Error("Uh-oh, username has changed or we never initialized correctly.")),e(t)})}},{key:"_safelyRunApiCommand",value:function(e,n){this._checkUserAndInit(function(t){if(t)return n(t,null);!function(e,n){var t={method:e.method,params:{version:1,options:e.options}};new Promise(function(e,n){a({command:"keybase",args:["chat","api"],stdinBuffer:new Buffer(JSON.stringify(t),"utf8")}).then(function(t){var s=null;if(t&&t.result)s=t.result;else if(t&&t.error){var a=t.error;n(new Error(a.message||a.toString()))}else n(new Error('Unknown error parsing result - no "result" field'));e(s)}).catch(function(e){n(e)})})}(e)})}}]),e}();t.d(n,"Bot",function(){return d})}])});